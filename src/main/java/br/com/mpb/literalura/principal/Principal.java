package br.com.mpb.literalura.principal;

import br.com.mpb.literalura.model.Book;
import br.com.mpb.literalura.model.ListBooks;
import br.com.mpb.literalura.model.Person;
import br.com.mpb.literalura.repository.BookRepository;
import br.com.mpb.literalura.repository.PersonRepository;
import br.com.mpb.literalura.service.ConsumoApi;
import br.com.mpb.literalura.service.ConverteDados;

import java.util.*;

public class Principal {
    private BookRepository bookRepository;
    private PersonRepository personRepository;
    private final String ENDERECO = "https://gutendex.com/books/?search=";
    private final String ENDERECOALL = "https://gutendex.com/books/?page=";
    private ConsumoApi consumoApi = new ConsumoApi();
    private ConverteDados converteDados = new ConverteDados();
    private Scanner leitura = new Scanner(System.in);
    String json = "";
    String confirmacao = "N";

    public Principal(BookRepository bookRepository, PersonRepository personRepository) {
        this.bookRepository = bookRepository;
        this.personRepository = personRepository;
    }

    public void exibirMenu() {
        int opcao = -1;
        do {
            menu();
            desenhaSeta();

            try {
                opcao = leitura.nextInt();
                leitura.nextLine(); // Limpa buffer ap√≥s leitura num√©rica
            } catch (InputMismatchException e) {
                System.out.println("‚ùå Entrada inv√°lida! Digite apenas n√∫meros.");
                leitura.nextLine(); // Limpa entrada incorreta
                pausa();
                continue;
            }

            switch (opcao) {
                case 1:
                    buscarLivroNaAPIEGravarBD();
                    pausa();
                    break;
                case 2:
                    listarLivrosCadastrados();
                    pausa();
                    break;
                case 3:
                    listarAutoresCadastrados();
                    pausa();
                    break;
                case 4:
                    buscarAutoresPorAno();
                    pausa();
                    break;
                case 5:
                    menuIdioma();
                    desenhaSeta();
                    buscarAutoresPorIdioma();
                    pausa();
                    break;
                case 6:
                    buscarEstatisticasLivrosAPI();
                    pausa();
                    break;
                case 7:
                    buscarTop10LivrosBD();
                    pausa();
                    break;
                case 8:
                    buscarAutorPorNomeBD();
                    pausa();
                    break;
                case 9:
                    buscarEstatisticasAutoresAno();
                    pausa();
                    break;
                case 0:
                    System.out.println("Saindo do Sistema...");
                    break;
                default:
                    System.out.println("Op√ß√£o Inv√°lida! Tente novamente.");
                    pausa();
            }
        } while (opcao != 0);
    }

    private void buscarEstatisticasAutoresAno() {
        System.out.println("Estat√≠sticas dos Anos de Nasc. e Morte:");
        List<Person> lista = personRepository.findAllByOrderByNameAsc();

        IntSummaryStatistics statistics1 = lista.stream()
                .mapToInt(Person::getBirthYear)
                .summaryStatistics();
        desenhaLinha();
        IntSummaryStatistics statistics2 = lista.stream()
                .mapToInt(Person::getDeathYear)
                .summaryStatistics();

        System.out.println("üìä Estat√≠sticas dos Autores:");
        desenhaLinha();
        System.out.println("Total de " + statistics1.getCount() + " Autores analisados.");
        desenhaLinha();
        System.out.println("üìÖ ANO DE NASCIMENTO:");
        System.out.printf("üìö Total analisado  : %d%n", statistics1.getCount());
        System.out.printf("üìä M√©dia de Nasc.   : %.2f%n", statistics1.getAverage());
        System.out.printf("üìâ M√≠nimo           : %d%n", statistics1.getMin());
        System.out.printf("üìà M√°ximo           : %d%n", statistics1.getMax());
        desenhaLinha();
        System.out.println("‚ö∞Ô∏è ANO DE MORTE:");
        System.out.printf("üìö Total analisado  : %d%n", statistics2.getCount());
        System.out.printf("üìä M√©dia de Morte   : %.2f%n", statistics2.getAverage());
        System.out.printf("üìâ M√≠nimo           : %d%n", statistics2.getMin());
        System.out.printf("üìà M√°ximo           : %d%n", statistics2.getMax());
        desenhaLinha();

        desenhaLinha();
    }

    private void buscarEstatisticasLivrosAPI() {
        int totalPaginas = -1;

        while (totalPaginas <= 0) {
            try {
                System.out.println("Digite a quantidade de p√°ginas (1 at√© ...):");
                desenhaSeta();
                totalPaginas = Integer.parseInt(leitura.nextLine().trim());

                if (totalPaginas <= 0) {
                    System.out.println("‚ùå N√∫mero inv√°lido! Digite um valor maior que zero.");
                }
            } catch (NumberFormatException e) {
                System.out.println("‚ùå Entrada inv√°lida! Digite apenas n√∫meros inteiros.");
            }
        }
        List<Book> books = buscarTodosOsLivros(totalPaginas);
        IntSummaryStatistics statistics = books.stream()
                .mapToInt(Book::getDownloadCount)
                .summaryStatistics();
        desenhaLinha();
        System.out.println("üìä Estat√≠sticas de Downloads:");
        desenhaLinha();
        System.out.printf("üìö Qt. de livros analisados : %d%n", statistics.getCount());
        System.out.printf("üì• Total de downloads       : %d%n", statistics.getSum());
        System.out.printf("üìä M√©dia de downloads       : %.2f%n", statistics.getAverage());
        System.out.printf("üìâ Menor n√∫mero de downloads: %d%n", statistics.getMin());
        System.out.printf("üìà Maior n√∫mero de downloads: %d%n", statistics.getMax());
        desenhaLinha();
    }

    private void buscarAutoresPorIdioma() {
        String idioma = leitura.nextLine().trim().replaceAll("[^a-zA-Z\\-]", "");
        ;
        List<Book> lista = bookRepository.buscarPorIdioma(idioma);
        if (lista.isEmpty()) {
            System.out.println("‚ùå Nenhum livro encontrado para o idioma: " + idioma);
            return;
        }
        System.out.println(lista);
        System.out.println("Quantidade de Livros üìö: " + lista.size());
        desenhaLinha();
    }

    private void buscarAutoresPorAno() {
        int ano = -1;

        while (ano < 0) {
            try {
                System.out.println("Digite um ano para pesquisa: üìÖ");
                desenhaSeta();
                ano = Integer.parseInt(leitura.nextLine().trim());

                if (ano < 0) {
                    System.out.println("‚ùå Ano inv√°lido! Digite um valor maior ou igual a zero.");
                }
            } catch (NumberFormatException e) {
                System.out.println("‚ùå Entrada inv√°lida! Digite apenas n√∫meros inteiros.");
            }
        }
        desenhaLinha();
        List<Person> lista = personRepository.findByBirthYearLessThanEqualAndDeathYearGreaterThanEqual(ano, ano);
        System.out.println(lista);
    }

    private void listarAutoresCadastrados() {
        List<Person> lista = personRepository.findAll();
        System.out.println(lista);
    }

    private void listarLivrosCadastrados() {
        List<Book> lista = bookRepository.findAll();
        System.out.println(lista);
    }

    private void buscarLivroNaAPIEGravarBD() {
            System.out.print("üìö Digite o nome do livro: ");
            desenhaSeta(); String livro = leitura.nextLine().trim().replaceAll(" ", "%20");
            desenhaLinha();
            json = consumoApi.obterDados(ENDERECO + livro);
            ListBooks listBook = converteDados.obterDados(json, ListBooks.class);

            if (listBook.getResults() != null && !listBook.getResults().isEmpty()) {
                Book book = listBook.getResults().get(0);
                System.out.println(book);
                pausa();

                System.out.println("üìö Deseja gravar livro no Banco de Dados? üíæ (S/N)");
                desenhaSeta();  confirmacao = leitura.nextLine();

                if (confirmacao.equalsIgnoreCase("S")) {
                    // Verifica se o livro j√° est√° no banco antes de salvar
                    Optional<Book> bookExistente = bookRepository.findByTitle(book.getTitle());
                    if (bookExistente.isPresent()) {
                        System.out.println("‚ÑπÔ∏è Livro j√° cadastrado! Atualizando informa√ß√µes...");
                        Book livroAtualizado = bookExistente.get();
                        livroAtualizado.setDownloadCount(book.getDownloadCount());
                        bookRepository.save(livroAtualizado);
                        System.out.println("‚úÖ Dados atualizados com sucesso! üíæ");
                    } else {
                        bookRepository.save(book);
                        System.out.println("‚úÖ Livro gravado com sucesso! üíæ");
                    }
                }
            } else {
                System.out.println("‚ùå Nenhum livro encontrado com esse nome.");
            }
    }

    private void menu() {
        String menu = """
        ------------------------------------------------
        üìñ Menu de Op√ß√µes:
        ------------------------------------------------
        1Ô∏è‚É£ - Buscar Livro pelo T√≠tulo (API Gutendex)
        2Ô∏è‚É£ - Listar Livros cadastrados üìö
        3Ô∏è‚É£ - Listar Autores cadastrados ‚úçÔ∏è
        4Ô∏è‚É£ - Listar Autores vivos em determinado ano üèõÔ∏è
        5Ô∏è‚É£ - Listar Livros em um determinado idioma üåé
        6Ô∏è‚É£ - Estat√≠sticas de Livros (API Gutendex) üìä
        7Ô∏è‚É£ - Top 10 Livros (Mais baixados) (BD) üî•
        8Ô∏è‚É£ - Buscar Autor por nome (BD) üîç
        9Ô∏è‚É£ - Estat√≠sticas Autor (BD) üìà
        
        üö™ 0 - Sair
        ------------------------------------------------
        üìå Escolha uma op√ß√£o:
        ------------------------------------------------
        """;
        System.out.println(menu);
    }

    private void menuIdioma() {
        String msg = """
        ------------------------------------------------
        üåç Digite a abrevia√ß√£o do idioma:
        ------‚¨áÔ∏è----------------------------------------
            üáßüá∑ pt - Portugu√™s
            üá™üá∏ es - Espanhol
            üá´üá∑ fr - Franc√™s
            üá∫üá∏ en - Ingl√™s
        ------------------------------------------------
        ‚úèÔ∏è Escolha uma op√ß√£o:
        ------------------------------------------------
        """;
        System.out.println(msg);
    }

    private void desenhaSeta() {
        System.out.print("‚û°Ô∏è ");
    }

    private void desenhaLinha() {
        System.out.println("------------------------------------------------");
    }

    private void pausa() {
        System.out.print("Pressione Enter para continuar...");
        leitura.nextLine();
    }

    private List<Book> buscarTodosOsLivros(int totalPaginas) {
        List<Book> allBooks = new ArrayList<>();

        for (int i = 1; i <= totalPaginas; i++) {
            json = consumoApi.obterDados(ENDERECOALL + i);
            ListBooks listBook = converteDados.obterDados(json, ListBooks.class);
            desenhaLinha();
            System.out.println("P√°gina atual: " + i + "\n");
            System.out.println(listBook);
            allBooks.addAll(listBook.getResults());
        }

        return allBooks;
    }

    private void buscarAutorPorNomeBD() {
        System.out.println("Digite o nome do Autor:");
        desenhaSeta();
        String nomeAutor = leitura.nextLine();
        List<Person> lista = personRepository.findByNameContainingIgnoreCaseOrderByNameAsc(nomeAutor);
        System.out.println(lista);
    }

    private void buscarTop10LivrosBD() {
        List<Book> lista = bookRepository.findTop10ByOrderByDownloadCountDesc();
        System.out.println(lista);
    }

}
